<head>
  <base target="_top">
  <meta charset="UTF-8">
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">

  <title>–ñ—É—Ä–Ω–∞–ª –≤–∏—ó–∑–¥—ñ–≤ / –ø–æ–≤–µ—Ä–Ω–µ–Ω—å</title>

  <style>
    /* ------------------------------
       –ì–õ–û–ë–ê–õ–¨–ù–Ü –ó–ú–Ü–ù–ù–Ü (–¢–ï–ú–ù–ê GOOGLE FORMS)
    ------------------------------ */
    :root {
      --bg: #202124;
      --surface: #292a2d;
      --surface-soft: #303134;
      --input-bg: #202124;
      --border: #5f6368;
      --accent: #8ab4f8;
      --accent-soft: rgba(138, 180, 248, 0.25);
      --text: #e8eaed;
      --text-muted: #9aa0a6;
      --error: #f28b82;
      --radius: 8px;
      --transition: 0.16s ease;
    }

    html, body {
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
      margin: 0;
      padding: 0;
      background: var(--bg);
      color: var(--text);
      font-family: Roboto, system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      -webkit-font-smoothing: antialiased;
      scroll-behavior: smooth;
    }

    input, select, textarea {
      font-size: 16px !important; /* –±–ª–æ–∫—É—î –∞–≤—Ç–æ–∑—É–º */
    }

    *, *::before, *::after {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    /* ------------------------------
       –ö–û–ù–¢–ï–ô–ù–ï–† ‚Äî –Ø–ö GOOGLE FORMS
    ------------------------------ */
    .page-wrapper {
      display: flex;
      justify-content: center;
      padding: 24px 12px;
    }

    .container {
      width: 100%;
      max-width: 640px;
      background: var(--bg);
      border-radius: 12px;
      padding: 24px 20px;
      box-shadow: 0 4px 16px rgba(0,0,0,0.35);
    }

    h2 {
      font-size: 22px;
      font-weight: 500;
      margin: 0 0 4px;
    }

    .subtitle {
      font-size: 13px;
      color: var(--text-muted);
      margin-bottom: 20px;
    }

    /* ------------------------------
       –ë–õ–û–ö–ò (CARDS)
    ------------------------------ */
    .block {
      background: var(--surface);
      padding: 20px 18px;
      border-radius: 12px;
      margin-bottom: 18px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.25);
    }

    .title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 14px;
      color: var(--text);
    }

    .subtitle-inline {
      font-size: 14px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    /* ------------------------------
       –ú–û–ë–Ü–õ–¨–ù–ê –ê–î–ê–ü–¢–ê–¶–Ü–Ø
    ------------------------------ */
    @media (max-width: 600px) {
      .container {
        padding: 20px 14px;
      }

      .block {
        padding: 18px 14px;
        border-radius: 10px;
      }

      .title {
        font-size: 16px;
        margin-bottom: 10px;
      }
    }

    /* ------------------------------
       –í–ï–†–•–ù–Ü–ô –†–Ø–î
    ------------------------------ */
    .top-row {
      display: flex;
      flex-wrap: wrap;
      gap: 16px;
      margin-bottom: 12px;
    }

    .top-col {
      flex: 1 1 200px;
      min-width: 200px;
    }

    @media (max-width: 600px) {
      .top-row {
        flex-direction: column;
        gap: 14px;
      }
      .top-col {
        min-width: 100%;
      }
    }

    /* ------------------------------
       –†–ê–î–Ü–û–ö–ù–û–ü–ö–ò ‚Äî GOOGLE FORMS STYLE
    ------------------------------ */
    .radio-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .radio-option {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 6px 4px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1.3;
      user-select: none;
      color: var(--text);
    }

    .radio-option:hover {
      background: rgba(138,180,248,0.08);
    }

    .radio-option input[type="radio"] {
      appearance: none;
      width: 20px;
      height: 20px;
      min-width: 20px;
      min-height: 20px;
      border-radius: 50%;
      border: 2px solid var(--accent);
      background: transparent;
      position: relative;
      cursor: pointer;
      flex-shrink: 0;
    }

    .radio-option input[type="radio"]:checked {
      background: var(--accent);
      border-color: var(--accent);
    }

    .radio-option input[type="radio"]:checked::after {
      content: "";
      position: absolute;
      inset: 4px;
      border-radius: 50%;
      background: var(--bg);
    }

    /* ------------------------------
       –ü–û–õ–Ø –í–í–û–î–£ ‚Äî GOOGLE FORMS STYLE
    ------------------------------ */
    .text-input,
    input[type="date"],
    input[type="time"],
    select.text-input {
      width: 100%;
      padding: 14px 16px;
      min-height: 48px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: var(--input-bg);
      color: var(--text);
      font-size: 16px;
      line-height: 1.4;
      transition: border-color var(--transition), box-shadow var(--transition);
    }

    .text-input:focus,
    input[type="date"]:focus,
    input[type="time"]:focus,
    select.text-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 2px var(--accent-soft);
      outline: none;
    }

    .text-input::placeholder {
      color: var(--text-muted);
      opacity: 0.9;
      font-size: 15px;
    }

    /* ------------------------------
       –ï–ö–Ü–ü–ê–ñ
    ------------------------------ */
    .crew-row {
      display: flex;
      gap: 8px;
      margin-top: 8px;
      align-items: center;
    }

    .crew-row button {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      border: none;
      cursor: pointer;
      background: rgba(255,255,255,0.06);
      color: var(--text-muted);
      font-size: 16px;
      transition: background var(--transition);
    }

    .crew-row button:hover {
      background: rgba(242,139,130,0.2);
      color: var(--error);
    }

    .add-btn {
      margin-top: 10px;
      padding: 8px 14px;
      border-radius: 999px;
      border: 1px dashed var(--border);
      background: transparent;
      color: var(--accent);
      font-size: 13px;
      cursor: pointer;
    }

    .add-btn:hover {
      background: rgba(138,180,248,0.08);
      border-color: var(--accent);
    }

    /* ------------------------------
       AUTOCOMPLETE ‚Äî –ú–û–ë–Ü–õ–¨–ù–ò–ô
    ------------------------------ */
    #globalSuggestBox {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      max-width: 360px;
      background: var(--surface-soft);
      border-radius: 6px;
      box-shadow: 0 6px 18px rgba(0,0,0,0.7);
      max-height: 240px;
      overflow-y: auto;
      display: none;
      opacity: 0;
      transition: opacity 0.15s ease;
      z-index: 9999;
      transform: translateY(4px);
    }

    #globalSuggestBox.visible {
      display: block;
      opacity: 1;
    }

    #globalSuggestBox div {
      padding: 12px 14px;
      cursor: pointer;
      font-size: 16px;
      line-height: 1.3;
      color: var(--text);
    }

    #globalSuggestBox div:hover {
      background: rgba(138,180,248,0.15);
    }

    /* ------------------------------
       –ö–ù–û–ü–ö–ê ‚Äî GOOGLE FORMS
    ------------------------------ */
    #submitBtn {
      width: 100%;
      margin-top: 24px;
      padding: 16px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      font-size: 17px;
      font-weight: 600;
      background: var(--accent);
      color: var(--bg);
      transition: background 0.15s ease, transform 0.1s ease, box-shadow 0.15s ease;
      box-shadow: 0 2px 6px rgba(0,0,0,0.25);
    }

    #submitBtn:hover:not(:disabled) {
      background: #a5c4fb;
    }

    #submitBtn:active:not(:disabled) {
      transform: scale(0.97);
    }

    #submitBtn:disabled {
      opacity: 0.55;
      cursor: default;
      transform: none;
    }

    /* ------------------------------
       –°–¢–ê–¢–£–°–ò
    ------------------------------ */
    #status {
      margin-top: 14px;
      font-size: 15px;
      font-weight: 500;
      min-height: 20px;
      transition: opacity 0.2s ease;
      opacity: 1;
    }

    #status.success {
      color: #81c995;
    }

    #status.error {
      color: #f28b82;
    }

    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <form id="mainForm" onsubmit="submitForm(event)">
    <div class="page-wrapper">
      <div class="container">

        <h2>–ñ—É—Ä–Ω–∞–ª –≤–∏—ó–∑–¥—ñ–≤ / –ø–æ–≤–µ—Ä–Ω–µ–Ω—å</h2>
        <div class="subtitle">–ó–∞–ø–æ–≤–Ω—ñ—Ç—å –¥–∞–Ω—ñ –µ–∫—ñ–ø–∞–∂—É, –º–∞—Ä—à—Ä—É—Ç—É, –≤–æ–¥—ñ—è —Ç–∞ —á–∞—Å—É.</div>

        <!-- –í–ï–†–•–ù–Ü–ô –ë–õ–û–ö -->
        <div class="block">
          <div class="top-row">

            <!-- –¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
            <div class="top-col">
              <div class="subtitle-inline">–¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó</div>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="operation" value="departure" checked data-field="operation">
                  –í–∏—ó–∑–¥
                </label>
                <label class="radio-option">
                  <input type="radio" name="operation" value="return" data-field="operation">
                  –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
                </label>
              </div>
            </div>

            <!-- –¢–∏–ø –µ–∫—ñ–ø–∞–∂—É -->
            <div class="top-col">
              <div class="subtitle-inline">–¢–∏–ø –µ–∫—ñ–ø–∞–∂—É</div>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="crewType" value="combat" checked data-field="crewType">
                  –ë–æ–π–æ–≤–∏–π
                </label>
                <label class="radio-option">
                  <input type="radio" name="crewType" value="noncombat" data-field="crewType">
                  –ù–µ–±–æ–π–æ–≤–∏–π
                </label>
              </div>
            </div>

            <!-- –î–∞—Ç–∞/—á–∞—Å –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
            <div class="top-col">
              <div class="subtitle-inline">–î–∞—Ç–∞ —Ç–∞ —á–∞—Å –æ–ø–µ—Ä–∞—Ü—ñ—ó</div>
              <div class="radio-group">
                <label class="radio-option">
                  <input type="radio" name="datetimeMode" value="auto" checked data-field="datetimeMode">
                  –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ
                </label>
                <label class="radio-option">
                  <input type="radio" name="datetimeMode" value="manual" data-field="datetimeMode">
                  –í—Ä—É—á–Ω—É
                </label>
              </div>
            </div>

          </div>

          <!-- –ü–æ–ª—è –¥–∞—Ç–∏/—á–∞—Å—É –æ–ø–µ—Ä–∞—Ü—ñ—ó -->
          <div id="operationDatetimeBlock" class="hidden" style="margin-top:14px;">
            <div class="datetime-row" id="operationDatetimeRow"></div>
          </div>
        </div>

        <!-- –î–ò–ù–ê–ú–Ü–ß–ù–ê –ó–û–ù–ê -->
        <div id="dynamicArea">

          <!-- –ë–ª–æ–∫ –¥–∞—Ç–∏ –≤–∏—ó–∑–¥—É (–¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è) -->
          <div id="departureDateBlock" class="block hidden">
            <div class="title">–î–∞—Ç–∞ –≤–∏—ó–∑–¥—É</div>
            <select id="departureDateSelect" class="text-input" data-field="departureDateSearch">
              <option value="">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –≤–∏—ó–∑–¥—É</option>
            </select>
          </div>

          <!-- –ú–∞—Ä—à—Ä—É—Ç -->
          <div class="block">
            <div class="title">–ú–∞—Ä—à—Ä—É—Ç</div>

            <!-- –ó–≤—ñ–¥–∫–∏ -->
            <input id="fromInput" class="text-input" type="text" placeholder="–ó–≤—ñ–¥–∫–∏"
                   data-suggest="locations" data-field="from">

            <!-- –ü–æ–∑–∏—Ü—ñ—ó (–¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è) -->
            <div id="fromPositionsBlock" class="hidden" style="margin-top:10px;">
              <div class="subtitle-inline">–ú–æ–∂–ª–∏–≤—ñ –ø–æ–∑–∏—Ü—ñ—ó (–ó–≤—ñ–¥–∫–∏)</div>
              <select id="fromPositionSelect" class="text-input" data-field="fromPosition">
                <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é</option>
              </select>
            </div>

            <!-- –ö—É–¥–∏ -->
            <input id="toInput" class="text-input" type="text" placeholder="–ö—É–¥–∏" style="margin-top:12px;"
                   data-suggest="locations" data-field="to">
          </div>

          <!-- –ú–µ—Ç–∞ -->
          <div id="goalBlock" class="block hidden">
            <div class="title">–ú–µ—Ç–∞ –≤–∏—ó–∑–¥—É</div>
            <input id="goalInput" class="text-input" type="text" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏..."
                   data-suggest="goals" data-field="goal">
          </div>

          <!-- –ï–∫—ñ–ø–∞–∂ -->
          <div class="block">
            <div class="title">–ï–∫—ñ–ø–∞–∂</div>
            <div id="crewList"></div>
            <button type="button" class="add-btn" onclick="addCrewRow()">+ –î–æ–¥–∞—Ç–∏ –ª—é–¥–∏–Ω—É</button>
          </div>

          <!-- –í–æ–¥—ñ–π / –ê–≤—Ç–æ -->
          <div class="block">
            <div class="title">–í–æ–¥—ñ–π / –ê–≤—Ç–æ</div>

            <input id="driverInput" class="text-input" type="text" placeholder="–í–æ–¥—ñ–π"
                   data-suggest="people" data-field="driver">

            <input id="carInput" class="text-input" type="text" placeholder="–ê–≤—Ç–æ" style="margin-top:12px;"
                   data-suggest="cars" data-field="car">
          </div>

        </div>

        <!-- –ö–Ω–æ–ø–∫–∞ -->
        <button id="submitBtn" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        <div id="status"></div>

        <!-- Autocomplete -->
        <div id="globalSuggestBox"></div>

      </div>
    </div>
  </form>
<script>
/* ---------------------------------------------------------
   0. –ì–ª–æ–±–∞–ª—å–Ω—ñ –∑–º—ñ–Ω–Ω—ñ —Ç–∞ URL
--------------------------------------------------------- */
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxw8u1N2-bXvjgyY75dGI-8EYDznibjE0pYWyg4tZFYbiLyVukbJ4I1K4S_Gm6GkFyN/exec";

let BASE = { people: [], goals: [], locations: [], cars: [] };
let BASE_READY = false;

let activeInput = null;
let activeList = [];
let suggestBox = null;

/* ---------------------------------------------------------
   1. Debounce (–¥–ª—è autocomplete)
--------------------------------------------------------- */
function debounce(fn, delay = 180) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

/* ---------------------------------------------------------
   2. –£—Ç–∏–ª—ñ—Ç–∞: —Ñ–æ—Ä–º–∞—Ç—É–≤–∞–Ω–Ω—è –¥–∞—Ç–∏ (—É–Ω—ñ—Ñ—ñ–∫–æ–≤–∞–Ω–æ)
--------------------------------------------------------- */
function formatDate(d) {
  if (!d) return "";
  const date = new Date(d);
  if (isNaN(date.getTime())) return d;

  const dd = ("0" + date.getDate()).slice(-2);
  const mm = ("0" + (date.getMonth() + 1)).slice(-2);
  const yyyy = date.getFullYear();
  return `${dd}.${mm}.${yyyy}`;
}

/* ---------------------------------------------------------
   3. –ü—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è –ø–æ–ª—ñ–≤ –∑ –ø–æ–º–∏–ª–∫–æ—é
--------------------------------------------------------- */
function highlightField(name) {
  const el = document.querySelector(`[data-field="${name}"]`);
  if (!el) return;

  el.classList.add("error-field");

  // –ü—Ä–æ–∫—Ä—É—Ç–∫–∞ –¥–æ –ø–æ–ª—è
  el.scrollIntoView({ behavior: "smooth", block: "center" });
}

/* –û—á–∏—â–µ–Ω–Ω—è –ø—ñ–¥—Å–≤—ñ—Ç–∫–∏ –ø—Ä–∏ –≤–≤–µ–¥–µ–Ω–Ω—ñ */
document.addEventListener("input", (e) => {
  if (e.target.dataset.field) {
    e.target.classList.remove("error-field");
    const status = document.getElementById("status");
    if (status) status.textContent = "";
  }
});

/* ---------------------------------------------------------
   4. –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏ (–æ–Ω–æ–≤–ª–µ–Ω–∞ –≤–µ—Ä—Å—ñ—è)
--------------------------------------------------------- */
function resetForm() {
  // –û—á–∏—â–µ–Ω–Ω—è –≤—Å—ñ—Ö input/select
  document.querySelectorAll("input, select, textarea").forEach(el => {
    if (el.type === "radio" || el.type === "checkbox") {
      el.checked = false;
    } else {
      el.value = "";
    }
    el.classList.remove("error-field");
  });

  // –ü–æ–≤–µ—Ä–Ω—É—Ç–∏ –¥–µ—Ñ–æ–ª—Ç–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è
  document.querySelector('input[name="operation"][value="departure"]').checked = true;
  document.querySelector('input[name="crewType"][value="combat"]').checked = true;
  document.querySelector('input[name="datetimeMode"][value="auto"]').checked = true;

  // –°—Ö–æ–≤–∞—Ç–∏ –±–ª–æ–∫–∏
  document.getElementById("operationDatetimeBlock").classList.add("hidden");
  document.getElementById("departureDateBlock").classList.add("hidden");
  document.getElementById("fromPositionsBlock").classList.add("hidden");
  document.getElementById("goalBlock").classList.add("hidden");

  // –û—á–∏—Å—Ç–∏—Ç–∏ –µ–∫—ñ–ø–∞–∂ —ñ –¥–æ–¥–∞—Ç–∏ –æ–¥–∏–Ω —Ä—è–¥–æ–∫
  const crewList = document.getElementById("crewList");
  crewList.innerHTML = "";
  addCrewRow();

  // –û—á–∏—Å—Ç–∏—Ç–∏ —Å—Ç–∞—Ç—É—Å
  const status = document.getElementById("status");
  if (status) status.textContent = "";

  // –§–æ–∫—É—Å –Ω–∞ –ø–µ—Ä—à–µ –ø–æ–ª–µ
  const first = document.querySelector("[data-field]");
  if (first) first.focus();
}

/* ---------------------------------------------------------
   5. –ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±–∞–∑–∏ (getBase)
--------------------------------------------------------- */
function loadBase() {
  fetch(SCRIPT_URL + "?action=getBase")
    .then(r => r.json())
    .then(data => {
      BASE = data || BASE;
      BASE_READY = true;
      suggestBox = document.getElementById("globalSuggestBox");
      renderInitialBlocks();
      initTopControlsLogic();
    })
    .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ getBase:", err));
}

loadBase();
</script>
<script>
/* ---------------------------------------------------------
   6. –†–µ–Ω–¥–µ—Ä –ø–æ—á–∞—Ç–∫–æ–≤–∏—Ö –±–ª–æ–∫—ñ–≤
--------------------------------------------------------- */
function renderInitialBlocks() {
  const area = document.getElementById('dynamicArea');

  area.innerHTML = `
    <!-- –ë–ª–æ–∫ –¥–∞—Ç–∏ –≤–∏—ó–∑–¥—É (–¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è) -->
    <div id="departureDateBlock" class="block hidden">
      <div class="title">–î–∞—Ç–∞ –≤–∏—ó–∑–¥—É</div>
      <select id="departureDateSelect" class="text-input" data-field="departureDateSearch">
        <option value="">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –≤–∏—ó–∑–¥—É</option>
      </select>
    </div>

    <!-- –ú–∞—Ä—à—Ä—É—Ç -->
    <div class="block">
      <div class="title">–ú–∞—Ä—à—Ä—É—Ç</div>

      <!-- –ó–≤—ñ–¥–∫–∏ -->
      <input id="fromInput" class="text-input" type="text" placeholder="–ó–≤—ñ–¥–∫–∏"
             data-suggest="locations" data-field="from">

      <!-- –ü–æ–∑–∏—Ü—ñ—ó (–¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è) -->
      <div id="fromPositionsBlock" class="hidden" style="margin-top:10px;">
        <div class="subtitle-inline">–ú–æ–∂–ª–∏–≤—ñ –ø–æ–∑–∏—Ü—ñ—ó (–ó–≤—ñ–¥–∫–∏)</div>
        <select id="fromPositionSelect" class="text-input" data-field="fromPosition">
          <option value="">–û–±–µ—Ä—ñ—Ç—å –ø–æ–∑–∏—Ü—ñ—é</option>
        </select>
      </div>

      <!-- –ö—É–¥–∏ -->
      <input id="toInput" class="text-input" type="text" placeholder="–ö—É–¥–∏" style="margin-top:12px;"
             data-suggest="locations" data-field="to">
    </div>

    <!-- –ú–µ—Ç–∞ -->
    <div id="goalBlock" class="block hidden">
      <div class="title">–ú–µ—Ç–∞ –≤–∏—ó–∑–¥—É</div>
      <input id="goalInput" class="text-input" type="text" placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏..."
             data-suggest="goals" data-field="goal">
    </div>

    <!-- –ï–∫—ñ–ø–∞–∂ -->
    <div class="block">
      <div class="title">–ï–∫—ñ–ø–∞–∂</div>
      <div id="crewList"></div>
      <button type="button" class="add-btn" onclick="addCrewRow()">+ –î–æ–¥–∞—Ç–∏ –ª—é–¥–∏–Ω—É</button>
    </div>

    <!-- –í–æ–¥—ñ–π / –ê–≤—Ç–æ -->
    <div class="block">
      <div class="title">–í–æ–¥—ñ–π / –ê–≤—Ç–æ</div>

      <input id="driverInput" class="text-input" type="text" placeholder="–í–æ–¥—ñ–π"
             data-suggest="people" data-field="driver">

      <input id="carInput" class="text-input" type="text" placeholder="–ê–≤—Ç–æ" style="margin-top:12px;"
             data-suggest="cars" data-field="car">
    </div>
  `;

  // –î–æ–¥–∞—î–º–æ –ø–µ—Ä—à–∏–π —Ä—è–¥–æ–∫ –µ–∫—ñ–ø–∞–∂—É
  addCrewRow();

  // –°–ª—É—Ö–∞—á—ñ
  document.getElementById('departureDateSelect')
    .addEventListener('change', loadPositions);

  document.getElementById('fromPositionSelect')
    .addEventListener('change', () => {
      applyFromPosition();
      loadLastRecordForReturn();
    });
}

/* ---------------------------------------------------------
   7. –õ–æ–≥—ñ–∫–∞ –≤–µ—Ä—Ö–Ω—å–æ–≥–æ –±–ª–æ–∫—É
--------------------------------------------------------- */
function initTopControlsLogic() {
  // –¢–∏–ø –æ–ø–µ—Ä–∞—Ü—ñ—ó
  document.querySelectorAll('input[name="operation"]').forEach(r => {
    r.addEventListener('change', () => {
      updateOperationDatetimeInputs();
      updateModeForOperation();
    });
  });

  // –¢–∏–ø –µ–∫—ñ–ø–∞–∂—É
  document.querySelectorAll('input[name="crewType"]').forEach(r => {
    r.addEventListener('change', () => {
      updateGoalVisibility();
      updateDepartureDatesForReturn();
    });
  });

  // –†–µ–∂–∏–º –¥–∞—Ç–∏/—á–∞—Å—É
  document.querySelectorAll('input[name="datetimeMode"]').forEach(r => {
    r.addEventListener('change', updateOperationDatetimeInputs);
  });

  updateOperationDatetimeInputs();
  updateModeForOperation();
  updateGoalVisibility();
}

/* ---------------------------------------------------------
   8. –ü–æ–ª—è –¥–∞—Ç–∏/—á–∞—Å—É –æ–ø–µ—Ä–∞—Ü—ñ—ó
--------------------------------------------------------- */
function updateOperationDatetimeInputs() {
  const mode = document.querySelector('input[name="datetimeMode"]:checked').value;
  const block = document.getElementById('operationDatetimeBlock');
  const row = document.getElementById('operationDatetimeRow');

  row.innerHTML = "";

  if (mode === "auto") {
    block.classList.add('hidden');
    return;
  }

  block.classList.remove('hidden');

  const dateInput = document.createElement('input');
  dateInput.type = 'date';
  dateInput.id = 'manualDate';
  dateInput.className = 'text-input';
  dateInput.dataset.field = "manualDate";

  const timeInput = document.createElement('input');
  timeInput.type = 'time';
  timeInput.id = 'manualTime';
  timeInput.className = 'text-input';
  timeInput.dataset.field = "manualTime";

  row.appendChild(dateInput);
  row.appendChild(timeInput);
}

/* ---------------------------------------------------------
   9. –í–∏—ó–∑–¥ / –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
--------------------------------------------------------- */
function updateModeForOperation() {
  const op = document.querySelector('input[name="operation"]:checked').value;

  const departureDateBlock = document.getElementById('departureDateBlock');
  const fromPositionsBlock = document.getElementById('fromPositionsBlock');
  const fromInput = document.getElementById('fromInput');
  const toInput = document.getElementById('toInput');

  if (op === "return") {
    departureDateBlock.classList.remove('hidden');
    fromInput.classList.add('hidden');
    fromPositionsBlock.classList.remove('hidden');

    toInput.value = "–ü–ü–î";
    toInput.disabled = true;

    document.getElementById('goalBlock').classList.add('hidden');

    updateDepartureDatesForReturn();
  } else {
    departureDateBlock.classList.add('hidden');
    fromInput.classList.remove('hidden');
    fromPositionsBlock.classList.add('hidden');

    toInput.disabled = false;
    toInput.value = "";

    updateGoalVisibility();
  }
}

/* ---------------------------------------------------------
   10. –ú–µ—Ç–∞ (–¥–ª—è –Ω–µ–±–æ–π–æ–≤–æ–≥–æ –µ–∫—ñ–ø–∞–∂—É –ø—Ä–∏ –≤–∏—ó–∑–¥—ñ)
--------------------------------------------------------- */
function updateGoalVisibility() {
  const op = document.querySelector('input[name="operation"]:checked').value;
  const crewType = document.querySelector('input[name="crewType"]:checked').value;
  const goalBlock = document.getElementById('goalBlock');

  if (op === "departure" && crewType === "noncombat") {
    goalBlock.classList.remove('hidden');
  } else {
    goalBlock.classList.add('hidden');
  }
}

/* ---------------------------------------------------------
   11. –î–∞—Ç–∞ –≤–∏—ó–∑–¥—É (–¥–ª—è –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è)
--------------------------------------------------------- */
function updateDepartureDatesForReturn() {
  const op = document.querySelector('input[name="operation"]:checked').value;
  if (op !== "return") return;

  const crewType = document.querySelector('input[name="crewType"]:checked').value;

  const params = new URLSearchParams({
    action: "getDepartureDates",
    crewType: crewType
  });

  fetch(SCRIPT_URL + "?" + params.toString())
    .then(r => r.json())
    .then(fillDepartureDatesSelect)
    .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ getDepartureDates:", err));
}

function fillDepartureDatesSelect(dates) {
  const select = document.getElementById("departureDateSelect");
  select.innerHTML = `<option value="">–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –≤–∏—ó–∑–¥—É</option>`;

  if (!Array.isArray(dates)) return;

  dates.forEach(d => {
    const opt = document.createElement("option");
    opt.value = d;
    opt.textContent = formatDate(d);
    select.appendChild(opt);
  });
}

/* ---------------------------------------------------------
   12. –ü–æ–∑–∏—Ü—ñ—ó "–ó–≤—ñ–¥–∫–∏" –¥–ª—è –≤–∏–±—Ä–∞–Ω–æ—ó –¥–∞—Ç–∏
--------------------------------------------------------- */
function loadPositions() {
  const date = document.getElementById("departureDateSelect").value.trim();
  const type = document.querySelector('input[name="crewType"]:checked').value;

  if (!date) return;

  const url = SCRIPT_URL + "?action=getPositions&date=" +
              encodeURIComponent(date) +
              "&crewType=" + encodeURIComponent(type);

  fetch(url)
    .then(r => r.json())
    .then(fillFromPositions)
    .catch(err => console.error("‚ùå –ü–æ–º–∏–ª–∫–∞ getPositions:", err));
}

function fillFromPositions(list) {
  const block = document.getElementById('fromPositionsBlock');
  const select = document.getElementById('fromPositionSelect');

  if (!Array.isArray(list) || list.length === 0) {
    block.classList.add('hidden');
    return;
  }

  block.classList.remove('hidden');
  select.innerHTML = "";

  list.forEach(pos => {
    const opt = document.createElement("option");
    opt.value = pos;
    opt.textContent = pos;
    select.appendChild(opt);
  });

  // üî• –î–û–î–ê–Ñ–ú–û –ê–í–¢–û–õ–û–ì–Ü–ö–£
  if (list.length === 1) {
    select.value = list[0];
    applyFromPosition();
    loadLastRecordForReturn();
  }
}

function applyFromPosition() {
  const value = document.getElementById('fromPositionSelect').value;
  if (!value) return;
  document.getElementById('fromInput').value = value;
}
</script>
<script>
/* ---------------------------------------------------------
   13. –ï–∫—ñ–ø–∞–∂ ‚Äî –¥–∏–Ω–∞–º—ñ—á–Ω—ñ —Ä—è–¥–∫–∏
--------------------------------------------------------- */
function addCrewRow(value = "") {
  const list = document.getElementById('crewList');

  const row = document.createElement('div');
  row.className = 'crew-row';

  const input = document.createElement('input');
  input.type = 'text';
  input.className = 'text-input';
  input.placeholder = '–Ü–º º—è / –ø–æ–∑–∏–≤–Ω–∏–π';
  input.value = value;
  input.dataset.suggest = "people";
  input.dataset.field = "crew";

  const del = document.createElement('button');
  del.textContent = '‚úï';
  del.onclick = () => {
    list.removeChild(row);

    // –Ø–∫—â–æ –≤—Å—ñ –≤–∏–¥–∞–ª–µ–Ω—ñ ‚Äî –¥–æ–¥–∞—î–º–æ –æ–¥–∏–Ω –ø–æ—Ä–æ–∂–Ω—ñ–π
    if (list.children.length === 0) {
      addCrewRow();
    }
  };

  row.appendChild(input);
  row.appendChild(del);
  list.appendChild(row);
}

/* ---------------------------------------------------------
   14. –ê–≤—Ç–æ–ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –µ–∫—ñ–ø–∞–∂—É / –≤–æ–¥—ñ—è / –∞–≤—Ç–æ
--------------------------------------------------------- */
function loadLastRecordForReturn() {
  const crewType = document.querySelector('input[name="crewType"]:checked').value;
  const date = document.getElementById('departureDateSelect').value.trim();
  const position = document.getElementById('fromPositionSelect').value;

  if (!crewType || !date || !position) return;

  const params = new URLSearchParams({
    action: "getLastReturnRecord",
    date: date,
    position: position,
    crewType: crewType
  });

  fetch(SCRIPT_URL + "?" + params.toString())
    .then(r => r.json())
    .then(applyLastRecordData)
    .catch(err => console.error("–ü–æ–º–∏–ª–∫–∞ getLastReturnRecord:", err));
}

function applyLastRecordData(info) {
  if (!info) return;

  // –í–æ–¥—ñ–π
  document.getElementById('driverInput').value = info.driver || "";

  // –ê–≤—Ç–æ
  document.getElementById('carInput').value = info.car || "";

  // –ï–∫—ñ–ø–∞–∂
  const crewList = document.getElementById('crewList');
  crewList.innerHTML = "";

  (info.crew || []).forEach(p => addCrewRow(p));

  // –Ø–∫—â–æ –µ–∫—ñ–ø–∞–∂ –ø–æ—Ä–æ–∂–Ω—ñ–π ‚Äî –¥–æ–¥–∞—î–º–æ —Ä—è–¥–æ–∫
  if (crewList.children.length === 0) {
    addCrewRow();
  }
}

/* ---------------------------------------------------------
   15. AUTOCOMPLETE (–∑ debounce)
--------------------------------------------------------- */
function getListByType(type) {
  switch (type) {
    case 'locations': return BASE.locations || [];
    case 'goals':     return BASE.goals || [];
    case 'people':    return BASE.people || [];
    case 'cars':      return BASE.cars || [];
    default:          return [];
  }
}

document.addEventListener('focusin', (e) => {
  if (!BASE_READY) return;

  const input = e.target;
  if (!input.matches('input[data-suggest]')) return;

  const type = input.dataset.suggest;
  const list = getListByType(type);

  activateSuggest(input, list);
});

function activateSuggest(input, list) {
  activeInput = input;
  activeList = list || [];

  input.oninput = debounce(() => updateSuggestBox());
  input.onblur = () => setTimeout(closeSuggestBox, 120);

  updateSuggestBox();
}

function updateSuggestBox() {
  if (!activeInput || !BASE_READY) return;

  const term = activeInput.value.trim().toLowerCase();
  suggestBox.innerHTML = "";

  if (!term) {
    closeSuggestBox();
    return;
  }

  const matches = activeList
    .map(x => String(x))
    .filter(x => x.toLowerCase().includes(term))
    .slice(0, 40);

  if (matches.length === 0) {
    closeSuggestBox();
    return;
  }

  matches.forEach(text => {
    const d = document.createElement("div");
    d.textContent = text;
    d.onmousedown = () => {
      activeInput.value = text;
      closeSuggestBox();
    };
    suggestBox.appendChild(d);
  });

  positionSuggestBox();
  suggestBox.classList.add("visible");
}

function positionSuggestBox() {
  if (!activeInput) return;

  const rect = activeInput.getBoundingClientRect();

  suggestBox.style.top = rect.bottom + "px";
  suggestBox.style.left = rect.left + "px";
  suggestBox.style.width = rect.width + "px";
}

function closeSuggestBox() {
  if (!suggestBox) return;
  suggestBox.classList.remove("visible");
  suggestBox.style.top = "-9999px";
}

window.addEventListener("scroll", () => {
  if (suggestBox && suggestBox.classList.contains("visible")) {
    positionSuggestBox();
  }
}, true);

window.addEventListener("resize", () => {
  if (suggestBox && suggestBox.classList.contains("visible")) {
    positionSuggestBox();
  }
});

/* ---------------------------------------------------------
   16. –í–ê–õ–Ü–î–ê–¶–Ü–Ø (–æ–Ω–æ–≤–ª–µ–Ω–∞, –∑ –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è–º)
--------------------------------------------------------- */
function validateForm(data) {
  const errors = [];

  /* 1. –ü–æ–ª–µ "–ó–≤—ñ–¥–∫–∏" */
  if (!data.from) {
    errors.push({ field: "from", message: "–ü–æ–ª–µ '–ó–≤—ñ–¥–∫–∏' –æ–±–æ–≤'—è–∑–∫–æ–≤–µ." });
  }

  /* 2. –ü–æ–ª–µ "–ö—É–¥–∏" */
  if (!data.to) {
    errors.push({ field: "to", message: "–ü–æ–ª–µ '–ö—É–¥–∏' –æ–±–æ–≤'—è–∑–∫–æ–≤–µ." });
  }

  /* 3. –í–∏—ó–∑–¥ ‚Üí –ö—É–¥–∏ –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ü–ü–î */
  if (data.operation === "departure" && data.to.toLowerCase() === "–ø–ø–¥") {
    errors.push({ field: "to", message: "–ü—Ä–∏ –≤–∏—ó–∑–¥—ñ –ø—É–Ω–∫—Ç '–ö—É–¥–∏' –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ü–ü–î." });
  }

  /* 4. –ù–µ–±–æ–π–æ–≤–∏–π –µ–∫—ñ–ø–∞–∂ ‚Üí –ø–æ—Ç—Ä—ñ–±–Ω–∞ –º–µ—Ç–∞ */
  if (data.operation === "departure" &&
      data.crewType === "noncombat" &&
      !data.goal) {
    errors.push({ field: "goal", message: "–î–ª—è –Ω–µ–±–æ–π–æ–≤–æ–≥–æ –µ–∫—ñ–ø–∞–∂—É –ø–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ –º–µ—Ç—É." });
  }

  /* 5. –†—É—á–Ω–∏–π —Ä–µ–∂–∏–º –¥–∞—Ç–∏/—á–∞—Å—É */
  if (data.datetimeMode === "manual") {
    if (!data.manualDate) {
      errors.push({ field: "manualDate", message: "–í–∫–∞–∂—ñ—Ç—å –¥–∞—Ç—É –æ–ø–µ—Ä–∞—Ü—ñ—ó." });
    }
    if (!data.manualTime) {
      errors.push({ field: "manualTime", message: "–í–∫–∞–∂—ñ—Ç—å —á–∞—Å –æ–ø–µ—Ä–∞—Ü—ñ—ó." });
    }
  }

  /* 6. –ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è ‚Üí –ø–æ—Ç—Ä—ñ–±–Ω–∞ –¥–∞—Ç–∞ –≤–∏—ó–∑–¥—É */
  if (data.operation === "return" && !data.departureDateSearch) {
    errors.push({ field: "departureDateSearch", message: "–û–±–µ—Ä—ñ—Ç—å –¥–∞—Ç—É –≤–∏—ó–∑–¥—É." });
  }

  /* 7. –í–æ–¥—ñ–π –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —á–ª–µ–Ω–æ–º –µ–∫—ñ–ø–∞–∂—É */
  if (data.driver && data.crew.includes(data.driver)) {
    errors.push({
      field: "driver",
      message: "–í–æ–¥—ñ–π –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ —á–ª–µ–Ω–æ–º –µ–∫—ñ–ø–∞–∂—É –æ–¥–Ω–æ—á–∞—Å–Ω–æ."
    });
  }

  /* 8. –î—É–±–ª—ñ–∫–∞—Ç–∏ –≤ –µ–∫—ñ–ø–∞–∂—ñ */
  const duplicates = data.crew.filter((x, i, arr) => arr.indexOf(x) !== i);
  if (duplicates.length > 0) {
    errors.push({
      field: "crew",
      message: "–£ –µ–∫—ñ–ø–∞–∂—ñ —î –ø–æ–≤—Ç–æ—Ä–∏: " + duplicates.join(", ")
    });
  }

  /* 9. –í–æ–¥—ñ–π –∞–±–æ —Ö–æ—á–∞ –± –æ–¥–∏–Ω —á–ª–µ–Ω –µ–∫—ñ–ø–∞–∂—É */
  if (data.crew.length === 0 && !data.driver) {
    errors.push({
      field: "crew",
      message: "–ü–æ—Ç—Ä—ñ–±–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ —Ö–æ—á–∞ –± –≤–æ–¥—ñ—è –∞–±–æ –æ–¥–Ω–æ–≥–æ —á–ª–µ–Ω–∞ –µ–∫—ñ–ø–∞–∂—É."
    });
  }

  return errors;
}

/* ---------------------------------------------------------
   17. –û–±—Ä–æ–±–∫–∞ –ø–æ–º–∏–ª–æ–∫: –ø—ñ–¥—Å–≤—ñ—á—É–≤–∞–Ω–Ω—è + —Å–∫—Ä–æ–ª
--------------------------------------------------------- */
function showValidationErrors(errors) {
  const status = document.getElementById("status");

  if (errors.length === 0) {
    status.textContent = "";
    return;
  }

  const first = errors[0];

  // –ü—ñ–¥—Å–≤—ñ—á—É—î–º–æ –ø–æ–ª–µ
  highlightField(first.field);

  // –ü–æ–∫–∞–∑—É—î–º–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
  status.style.color = "#f28b82";
  status.textContent = first.message;
}

/* ---------------------------------------------------------
   18. SUBMIT FORM (—Ñ—ñ–Ω–∞–ª—å–Ω–∞ –≤–µ—Ä—Å—ñ—è)
--------------------------------------------------------- */
function submitForm(event) {
  event.preventDefault();

  const btn = document.getElementById('submitBtn');
  const status = document.getElementById('status');

  // –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –ø–æ–¥–≤—ñ–π–Ω–æ–≥–æ –∫–ª—ñ–∫—É
  if (btn.disabled) return;

  /* ---------------------------------------------------------
     1. –ó–±—ñ—Ä –¥–∞–Ω–∏—Ö
  --------------------------------------------------------- */
  const op = document.querySelector('input[name="operation"]:checked').value;

  const data = {
    operation: op,
    crewType: document.querySelector('input[name="crewType"]:checked').value,

    goal: op === "departure"
      ? (document.getElementById('goalInput')?.value.trim() || "")
      : "",

    from: document.getElementById('fromInput').value.trim(),
    to: document.getElementById('toInput').value.trim(),

    datetimeMode: document.querySelector('input[name="datetimeMode"]:checked').value,
    manualDate: document.getElementById('manualDate')?.value || "",
    manualTime: document.getElementById('manualTime')?.value || "",

    departureDateSearch:
      op === "return"
        ? document.getElementById('departureDateSelect').value
        : "",

    crew: [...document.querySelectorAll('#crewList .text-input[data-field="crew"]')]
      .map(i => i.value.trim())
      .filter(Boolean),

    driver: document.getElementById('driverInput').value.trim(),
    car: document.getElementById('carInput').value.trim()
  };

  /* ---------------------------------------------------------
     2. –í–∞–ª—ñ–¥–∞—Ü—ñ—è
  --------------------------------------------------------- */
  const errors = validateForm(data);

  if (errors.length > 0) {
    showValidationErrors(errors);
    return;
  }

  /* ---------------------------------------------------------
     3. –ü—ñ–¥–≥–æ—Ç–æ–≤–∫–∞ –¥–æ –≤—ñ–¥–ø—Ä–∞–≤–∫–∏
  --------------------------------------------------------- */
  btn.disabled = true;
  btn.textContent = "‚è≥ –í—ñ–¥–ø—Ä–∞–≤–∫–∞...";
  status.textContent = "–û–±—Ä–æ–±–∫–∞...";
  status.style.color = "#9aa0a6";

  const params = new URLSearchParams({
    action: "submitRecord",
    operation: data.operation,
    crewType: data.crewType,
    goal: data.goal,
    from: data.from,
    to: data.to,
    datetimeMode: data.datetimeMode,
    manualDate: data.manualDate,
    manualTime: data.manualTime,
    departureDateSearch: data.departureDateSearch,
    driver: data.driver,
    car: data.car,
    crew: data.crew.join(",")
  });

  /* ---------------------------------------------------------
     4. –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
  --------------------------------------------------------- */
  fetch(SCRIPT_URL + "?" + params.toString())
    .then(r => r.json())
    .then(() => {
      btn.disabled = false;
      btn.textContent = "‚úÖ –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ";
      status.textContent = "–î–∞–Ω—ñ —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ";
      status.style.color = "#81c995";

      // –û—á–∏—â–µ–Ω–Ω—è —Ñ–æ—Ä–º–∏
      resetForm();

      setTimeout(() => {
        btn.textContent = "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏";
      }, 2000);
    })
    .catch(err => {
      btn.disabled = false;
      btn.textContent = "‚ùå –ü–æ–º–∏–ª–∫–∞";
      status.textContent = "–ü–æ–º–∏–ª–∫–∞ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è.";
      status.style.color = "#f28b82";
      console.error(err);

      setTimeout(() => {
        btn.textContent = "–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏";
      }, 2000);
    });
}
</script>
