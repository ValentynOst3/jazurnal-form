<!DOCTYPE html>
<html lang="uk">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Журнал виїздів</title>

<style>
body {
  font-family: system-ui, -apple-system, BlinkMacSystemFont;
  background: #f0fdf4;
  margin: 0;
  padding: 16px;
}

.card {
  max-width: 600px;
  margin: auto;
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.1);
}

h2 {
  margin-top: 0;
  color: #065f46;
}

label {
  display: block;
  margin-top: 16px;
  font-weight: 600;
}

input, select, button {
  width: 100%;
  padding: 12px;
  margin-top: 6px;
  border-radius: 10px;
  border: 1px solid #ccc;
  font-size: 16px;
}

input[readonly] {
  background: #f9fafb;
  cursor: pointer;
}

button {
  margin-top: 24px;
  background: #16a34a;
  color: white;
  font-size: 18px;
  border: none;
}

button:hover {
  background: #15803d;
}

/* ===== Overlay (як Google Forms) ===== */
.overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.45);
  display: none;
  z-index: 999;
}

.sheet {
  position: absolute;
  bottom: 0;
  width: 100%;
  max-height: 85%;
  background: white;
  border-radius: 18px 18px 0 0;
  padding: 16px;
  overflow: auto;
}

.sheet input {
  border-radius: 12px;
}

.option {
  padding: 14px;
  border-bottom: 1px solid #eee;
}

.option:hover {
  background: #ecfdf5;
}
</style>
</head>

<body>

<div class="card">
<h2>Запис виїзду</h2>

<label>Тип екіпажу</label>
<select id="type">
  <option value="">— обери —</option>
  <option value="Бойовий">Бойовий</option>
  <option value="Не бойовий">Не бойовий</option>
</select>

<label>Звідки</label>
<input id="from" readonly placeholder="Обери" onclick="openSelect(locations,'from')">

<label>Куди</label>
<input id="to" readonly placeholder="Обери" onclick="openSelect(locations,'to')">

<label id="purposeLabel" style="display:none;">Мета</label>
<input id="purpose" readonly placeholder="Обери" style="display:none;"
       onclick="openSelect(purposes,'purpose')">

<h3>Склад екіпажу</h3>

<input id="p1" readonly placeholder="1 людина" onclick="openSelect(people,'p1')">
<input id="p2" readonly placeholder="2 людина" onclick="openSelect(people,'p2')">
<input id="p3" readonly placeholder="3 людина" onclick="openSelect(people,'p3')">
<input id="p4" readonly placeholder="4 людина" onclick="openSelect(people,'p4')">
<input id="p5" readonly placeholder="5 людина" onclick="openSelect(people,'p5')">
<input id="p6" readonly placeholder="6 людина" onclick="openSelect(people,'p6')">

<input id="s1" readonly placeholder="1 супровід" onclick="openSelect(people,'s1')">
<input id="s2" readonly placeholder="2 супровід" onclick="openSelect(people,'s2')">

<input id="driver" readonly placeholder="Водій" onclick="openSelect(people,'driver')">

<button onclick="send()">Відправити</button>
</div>

<!-- ===== Overlay ===== -->
<div id="overlay" class="overlay" onclick="closeSelect(event)">
  <div class="sheet">
    <input id="search" placeholder="Пошук..." oninput="filterList()">
    <div id="list"></div>
  </div>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxmsbybL9Ka-6VRJZIuWLuh4YV7ojdSBywxvMTq9zI4gdW_VA3Hhwj4O3ACzvT3c50S/exec";

/* ===== Дані з бази ===== */
let people = [];
let locations = [];
let purposes = [];

/* ===== Select engine ===== */
let currentTarget = null;
let currentData = [];

function openSelect(data, targetId) {
  currentTarget = document.getElementById(targetId);
  currentData = data;
  document.getElementById("overlay").style.display = "block";
  document.getElementById("search").value = "";
  renderList(data);
}

function closeSelect(e) {
  if (e.target.id === "overlay") {
    document.getElementById("overlay").style.display = "none";
  }
}

function renderList(data) {
  const list = document.getElementById("list");
  list.innerHTML = "";
  data.forEach(v => {
    const div = document.createElement("div");
    div.className = "option";
    div.textContent = v;
    div.onclick = () => {
      currentTarget.value = v;
      document.getElementById("overlay").style.display = "none";
    };
    list.appendChild(div);
  });
}

function filterList() {
  const q = document.getElementById("search").value.toLowerCase();
  renderList(currentData.filter(v => v.toLowerCase().includes(q)));
}

/* ===== Завантаження довідників ===== */
fetch(SCRIPT_URL)
  .then(r => r.json())
  .then(data => {
    people = data.people || [];
    locations = data.locations || [];
    purposes = data.purposes || [];
  });

/* ===== Логіка ===== */
type.onchange = () => {
  const show = type.value === "Не бойовий";
  purpose.style.display = show ? "block" : "none";
  purposeLabel.style.display = show ? "block" : "none";
  if (!show) purpose.value = "";
};

function send() {
  if (!type.value || !from.value || !to.value) {
    alert("Заповни обовʼязкові поля");
    return;
  }

  const crew = [
    p1.value,p2.value,p3.value,p4.value,p5.value,p6.value,
    s1.value,s2.value,driver.value
  ].filter(Boolean);

  const dup = crew.filter((v,i,a)=>a.indexOf(v)!==i);
  if (dup.length) {
    alert("Дублікати: " + dup.join(", "));
    return;
  }

  const params = new URLSearchParams({
    type:type.value,from:from.value,to:to.value,purpose:purpose.value,
    p1:p1.value,p2:p2.value,p3:p3.value,p4:p4.value,p5:p5.value,p6:p6.value,
    s1:s1.value,s2:s2.value,driver:driver.value
  });

  fetch(SCRIPT_URL + "?" + params)
    .then(() => alert("Запис додано"));
}
</script>

</body>
</html>
